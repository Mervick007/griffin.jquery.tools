// // griffin.tools - Copyright 2012 Jonas Gauffin (jgauffin) - License: LGPL

(function($){"use strict";$.griffin=$.extend({dialog:{globals:{texts:{title:'Please wait, loading..'},translations:[]}}},$.griffin,true);var methods={init:function(options){var settings=$.extend({container:'<div class="dialog-container"></div>',title:null,success:null},options,true);return this.each(function(){var $this=$(this);var self=this;var data=$this.data('griffin-ajax-dialog');this.handleResponse=function($form,response,success){if(!response.success){var container=$($form).find("[data-valmsg-summary=true]");if(response.contentType==='model-errors'){var str='<dl>';$.each(response.body,function(name,errors){str+='<dt>'+name+'</dt><dd><ul>';$.each(errors,function(index,error){str+='<li>'+error+'</li>\n';});str+='</ul></dd>';});str+='</dl>';$.griffin.ui.dialogs.alert({title:'Validation error!',message:str});return;}else if(response.contentType==='validation-rules'){response.body.debug=true;$form.validate().showErrors();$form.removeData("validator");$form.validate(response.body).valid();}else if(container.length!==0){container.removeClass('validation-summary-valid');container.addClass('validation-summary-errors');$('ul',container).append('<li>'+response.body+'</li>');}else{$.griffin.ui.dialogs.alert({title:'Failure',message:response.body});}}
else{success();}};this.handleSubmit=function($form,$target,callback){if(jQuery().validate&&!$form.valid()){return;}
var container=$($form).find("[data-valmsg-summary=true]");if(container.length!==0){container.addClass('validation-summary-valid');container.removeClass('validation-summary-errors');$('li',container).remove();}
$.ajax($form.attr('action'),{type:$form.attr('method'),data:$form.serialize(),success:function(response){self.handleResponse($form,response,function(){callback();if(data.options.success!==null){data.options.success.apply(self,[response]);}else{$.griffin.jsonResponse($form,response);}});}});};this.initializeForm=function(contents){data.dialog.html(contents);$.triggerLoaded(data.dialog[0]);var $buttons=$('input[type="submit"], input[type="button"]',data.dialog).hide();var dialogOptions={title:$this.html(),modal:true,width:'auto',buttons:[],closed:function(){if(data.removeWhenDone){data.dialog.remove();}}};var $form=$('form',data.dialog);if($form.length!==1){throw'There must only be one form in the contents that the dialog is generated for';}
var target=data.target;if(data.target.length===0){target=$form;}
$form.submit(function(e){e.preventDefault();self.handleSubmit($form,target,function(){data.dialog.dialog('close');});});if($.validator&&$.validator.unobtrusive){$form.removeData("validator");$form.removeData("unobtrusiveValidation");$.validator.unobtrusive.parse($form);}
$buttons.each(function(){if($(this).attr('type')==='submit'){dialogOptions.buttons.push({text:$(this).val(),click:function(){$form.submit();}});}else{dialogOptions.buttons.push({text:$(this).val(),click:function(){data.dialog.dialog('close');}});}});data.dialog.dialog(dialogOptions);};if(typeof data==='undefined'){if($this.hasClass('delete')){$this.click(function(e){e.preventDefault();$.griffin.ui.dialogs.confirm({title:'Delete item',message:'Do you really want to delete the selected item?',yes:function(){$.post($this.attr('href'),function(data){$.griffin.jsonResponse(data.target,data);});}});});return this;}
data={removeWhenDone:false};data.target=$('#'+$this.attr('rel'));data.options=settings;$this.click(function(e){e.preventDefault();var overlay={elementOverlay:function(){}};if(jQuery().elementOverlay){overlay=$(this).elementOverlay();}
$.get($(this).attr('href'),function(dialogContents){overlay.elementOverlay('destroy');data.dialog=$(settings.container);if(settings.container.substr(0,1)!=='#'){data.dialog.appendTo('body');data.removeWhenDone=true;}
self.initializeForm(dialogContents);});});}
return this;});},destroy:function(){return this.each(function(){var $this=$(this),data=$this.data('griffin-ajax-dialog');$(window).unbind('.griffin-ajax-dialog');data.overlay.remove();$this.removeData('griffin-ajax-dialog');});},show:function(){var $this=$(this),data=$this.data('griffin-ajax-dialog');data.target2.reposition();data.overlay.show();return this;},hide:function(){var $this=$(this),data=$this.data('griffin-ajax-dialog');data.overlay.hide();return this;}};$.fn.griffinDialog=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else{$.error('Method '+method+' does not exist on jQuery.griffinDialog');}};})(jQuery);if(typeof $.loaded!=='undefined'){$.loaded(function(parent){"use strict";$('a.ajax-dialog',parent).griffinDialog();});}
(function($){"use strict";$.elementOverlay={texts:{title:'Please wait, loading..'},translations:[]};var methods={init:function(options){var settings=$.extend({overlay:'<div class="ui-widget-overlay element-overlay-bk" id="{{id}}"></div>',spinner:'<div class="element-overlay-contents">{{contents}}</div>',title:$.elementOverlay.texts.title},options,true);return this.each(function(){var $this=$(this);var self=this;var data=$this.data('griffin-element-overlay');this.reposition=function(){var pos=$this.offset();if(!pos){pos={top:0,left:0};}
data.overlay.css({position:'absolute',top:pos.top,left:pos.left,width:$this.width()+"px",height:$this.height()+"px"});data.spinner.css({zindex:100,position:'absolute',top:pos.top,left:pos.left,width:$this.width()+"px",height:$this.height()+"px"});$(data.spinner).css('padding-top',(($this.height()/2)-20)+'px');};if(!data){data={settings:settings,self:this};var id=$this.attr('id')+'-overlay';data.overlay=settings.overlay;if(data.overlay.substr(0,1)!=='#'){data.overlay=data.overlay.replace('{{id}}',id);}
data.overlay=$(data.overlay);data.spinner=settings.spinner;if(data.spinner.substr(0,1)!=='#'){data.spinner=data.spinner.replace('{{contents}}',settings.title);}
data.spinner=$(data.spinner);$('body').append(data.overlay);$('body').append(data.spinner);this.reposition();$(this).data('griffin-element-overlay',data);}else{methods['show'].apply(self);}
return this;});},destroy:function(){return this.each(function(){var $this=$(this),data=$this.data('griffin-element-overlay');if(!data){return;}
$(window).unbind('.elementOverlay');data.overlay.remove();data.spinner.remove();$this.data('griffin-element-overlay',null);$this.removeData('overlay');});},show:function(){var $this=$(this),data=$this.data('griffin-element-overlay');data.self.reposition();data.overlay.show();data.spinner.show();return this;},hide:function(){var $this=$(this),data=$this.data('griffin-element-overlay');data.overlay.hide();data.spinner.hide();return this;}};$.fn.elementOverlay=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else{$.error('Method '+method+' does not exist on jQuery.elementOverlay');}};})(jQuery);$.loadedMethods=[];$.loaded=function(func){"use strict";$.loadedMethods.push(func);};$.triggerLoaded=function(parent){"use strict";$.each($.loadedMethods,function(index,func){func.apply(parent);});if(jQuery().validator){jQuery.validator.unobtrusive.parse($(parent));}
$.loadedMethods=[];};$(function(){"use strict";$.triggerLoaded($('body')[0]);});$.griffin={};function isArray(obj){"use strict";return Object.prototype.toString.call(obj)==='[object Array]';}
function isNonEmptyArrayLike(obj){"use strict";try{return obj.length>0&&'0'in Object(obj);}
catch(e){return false;}}
$.griffin.jsonResponse=function($target,json){"use strict";if(typeof $target==='undefined'){throw'$target was not specified';}
console.log(json.body);if(typeof json.success==='undefined'||typeof json.body==='undefined'||typeof json.contentType==='undefined'){console.log(json);throw'Expected to get the { success: true/false, contentType: "theType", body: {} } JSON respone';}
if(!json.success){$.griffin.dialogs.alert(json.body);return this;}
var args={handled:false,response:json};PubSub.publish('griffin.json-response',args);var data=json.body;if(!args.handled){if(data.action==='model'){PubSub.publish('griffin.model.'+data.body.modelName+'.load',data.body);return this;}
else if(data.action==='delete'){$target.remove();return this;}
else if(typeof data.contentType!=='undefined'&&(data.contentType==='html'||data.contentType==='string')){if(data.action==='replace'){$target.html(data.content);return this;}else if(data.action==='add'){$target.append(data.content);return this;}}else if(data.action==='dialog'){$.griffin.dialogs.alert('Success',data.content);return this;}}};String.prototype.capitalize=function(){"use strict";return this.replace(/(^|\s)([a-z])/g,function(m,p1,p2){return p1+p2.toUpperCase();});};isArray=function(obj){"use strict";return Object.prototype.toString.call(obj)==='[object Array]';};!(typeof define!=="function"?function($){$(null,typeof exports!=='undefined'?exports:window)}:define)(function(require,exports){"use strict";exports.Base=Object.freeze(Object.create(Object.prototype,{'new':{value:function create(){var object=Object.create(this);object.initialize.apply(object,arguments);return object}},initialize:{value:function initialize(){}},merge:{value:function merge(){var descriptor={};Array.prototype.forEach.call(arguments,function(properties){Object.getOwnPropertyNames(properties).forEach(function(name){descriptor[name]=Object.getOwnPropertyDescriptor(properties,name)})});Object.defineProperties(this,descriptor);return this}},extend:{value:function extend(){return Object.freeze(this.merge.apply(Object.create(this),arguments))}}}))});var RestlessRepository=Base.extend({_self:this,_items:[],initialize:function(modelName,uri){this.modelName=modelName;if(typeof uri==='undefined'||uri===null){this.uri='/'+modelName+'/';}else{if(uri.substr(uri.length-1,1)!=='/'){uri=uri+'/';}
this.uri=uri;}},getId:function(item){return $.griffin.model.getId(item);},publish:function(){},_getItem:function(itemOrId){if(typeof itemOrId==='number'){return this._items[itemOrId];}
return this._items[this.getId(itemOrId)];},load:function(modelOrId){if(typeof modelOrId==='number'){return this._getItem(modelOrId);}
this._items[this.getId(modelOrId)]=modelOrId;PubSub.publish('griffin.model.'+this.modelName+'.loaded',{modelName:this.modelName,model:modelOrId});},setItem:function(item){this._items[this.getId(item)]=item;},update:function(model){this._perform('update','updated',model);},create:function(model){this._perform('create','created',model);},handleMessage:function(data){switch(data.actionName){case'create':PubSub.publish('griffin.model.'+this.modelName+'.created',{modelName:this.modelName,model:data.model});case'load':this.load(data.model);break;case'update':this.setItem(data.model);PubSub.publish('griffin.model.'+this.modelName+'.updated',{modelName:this.modelName,model:data.model});break;case'delete':delete this._items[this.getId(data.model)];PubSub.publish('griffin.model.'+this.modelName+'.deleted',{modelName:this.modelName,model:data.model});break;}},delete:function(modelOrId){var id=modelOrId;if(typeof id!=='number'){id=this.getId(modelOrId);}
var result=$.post(uri+'delete/'+id,model,function(data){if(response.success){delete this._items[id];PubSub.publish('griffin.model.'+_self.modelName+'.deleted',{modelName:this.modelName,model:model});}else{PubSub.publish('griffin.response',data);}});},_perform:function(actionName,eventName,model){var result=$.post(url+actionName+'/'+model.id,model,function(data){if(response.success){_self.setItem(data);PubSub.publish('griffin.model.'+_self.modelName+'.'+eventName,{modelName:this.modelName,model:model});}else{PubSub.publish('griffin.response',data);}});}});(function($){"use strict";$.griffin.renderItem=function($target,data){var internalRenderer=function(){};var renderRowUsingJsRender=function($target,row){var template=$target.data('griffin-render-node');return $(template.render(row));},renderRowUsingTmpl=function($target,row){return $.tmpl("griffin-render-template",row);},initialize=function(){var templateNode=$('[data-template-for="'+$target.attr('id')+'"]');if(templateNode.length===1){$target.data('griffin-render-node',templateNode);if(jQuery().render){$target.data('griffin-renderer',renderRowUsingJsRender);}else if(jQuery().tmpl){$.template("griffin-render-template",templateNode);$target.data('griffin-renderer',renderRowUsingTmpl);}else{throw'Failed to find on of the jQuery tmpl and jsRender template engines';}
return this;}else{throw'No template was found for '+$target.attr('id');}};var renderer=$target.data('griffin-renderer');if(typeof renderer==='undefined'){initialize();renderer=$target.data('griffin-renderer');}
var item=renderer($target,data);item.attr('data-model-id',$.griffin.model.getId(data));item.data('griffin.model',data);return item;};$.griffin.model={};$.griffin.model.Object=function(){var _repositories={},self=this,publish=function(name,args){PubSub.publish(name,args);};this.getId=function(item){if(typeof item==='number'){return item;}
return item.id;};this.getRepos=function(modelName){return _repositories[modelName];};this.createRepository=function(modelName){return RestlessRepository.new(modelName);};this.init=function(modelNames){$.each(modelNames,function(index,modelName){var repos=self.createRepository(modelName);_repositories[modelName]=repos;});};this.from=function($obj){var selector='';if($obj[0].tagName==='FORM'){selector='input[type!="submit"], input[type!="button"]';}else if($obj[0].tagName==='TR'){return $obj.data('griffin.model');}
var arr=[];$('input[type!="submit"], input[type!="button"]',$obj).each(function(){var name=$(this).attr('name');if(typeof name==='undefined'){return this;}
var value=$(this).val();arr[name]=value;});console.log(arr);return $.extend({},arr);}
PubSub.subscribe('griffin.model',function(eventName,data){if(eventName.substr(-4,4)==='load'){self.getRepos(data.modelName).handleMessage(data);}
else if(eventName.substr(-7,7)==='deleted'){self.remove(data.modelName,data.model);}
else if(eventName.substr(-6,6)==='loaded'||eventName.substr(-7,7)==='updated'){self.load(data.modelName,data.model);}});this.add=function(modelName,items){if(!isArray(items)){items=[items];}
var repos=self.getRepos(modelName);$.each(items,function(index,item){repos.load(item);});}
this.load=function(modelName,data){var updateItem=function($target,itemData){var id=self.getId(itemData).toString();if($target.attr('data-model-id')&&$target.attr('data-model-id')!==id){return;}
var $existing=$('[data-model-id="'+id+'"]',$target);if($existing.length===1){$existing.replaceWith($.griffin.renderItem($target,itemData));publish('griffin.model.'+modelName+'.node-updated.'+self.getId(itemData),{model:itemData,modelName:modelName,target:$target});}else{var node=$.griffin.renderItem($target,itemData).appendTo($target);publish('griffin.model.'+modelName+'.node-created.'+self.getId(itemData),{model:itemData,modelName:modelName,target:$(node)});}};$('[data-model-name="'+modelName+'"]').each(function(){var $this=$(this);if(!isArray(data)){data=[data];}
$.each(data,function(index,item){updateItem($this,item);});});};this.remove=function(modelName,model){var id=model.id;if(typeof id!=='number'){id=self.getId(model);}
$('[data-model-name="'+modelName+'"]').each(function(){var $this=$(this);if(typeof $this.attr('data-model-id')==='undefined'){$('[data-model-id="'+id+'"]',$this).each(function(){$(this).remove();});}
else{$this.remove();}});};};$.griffin.model=new $.griffin.model.Object();})(jQuery);(function($){"use strict";var methods={init:function(options){var settings=$.extend({overlay:'#griffin-tour-overlay',container:'#griffin-tour-container',effect:'highlight',quit:function(){}},options);return this.each(function(){var $this=$(this);var self=this;var data=$this.data('griffin-tour');this.elementInViewport=function(el){var rect=el.getBoundingClientRect()
return(rect.top>=0&&rect.left>=0&&rect.bottom<=window.innerHeight&&rect.right<=window.innerWidth)}
this.start=function(){data.overlay.show();data.overlay.addClass('ui-widget-overlay');var height=$('body').height();if(height<$(window).height())
height=$(window).height();data.overlay.height(height);if(data.index>=data.items.length-1){$('.next',data.container).hide();}
$('.previous',data.container).hide();this.spotlight(0);}
this.spotlight=function(index){var item=data.items[index];$('.contents',data.container).html(item.html());var targetItem=$(item.attr('data-for'));if(targetItem.length===0){data.container.position({"my":"center center","at":"center center","of":$(window)});if(data.container.css('display')==='none'){data.container.show();}
return;}
targetItem.addClass('griffin-tour-spotlight');data.container.position({"my":"left top","at":"left bottom","of":targetItem});if(!self.elementInViewport(targetItem[0])){$('body, html').animate({scrollTop:targetItem.offset().top},1000,function(){if(data.container.css('display')==='none'){data.container.show();}
targetItem.effect('highlight');});}else
{if(data.container.css('display')==='none'){data.container.show();}
targetItem.effect('highlight');}};this.fadeAway=function(index){var item=data.items[index];var targetItem=$(item.attr('data-for'));targetItem.removeClass('griffin-tour-spotlight');}
this.moveNext=function(){self.fadeAway(data.index);data.index=data.index+1;self.spotlight(data.index);if(data.index>=data.items.length-1){$('.next',data.container).hide();}
if(!$('.previous',data.container).is(':visible')){$('.previous',data.container).show();}};this.movePrev=function(){self.fadeAway(data.index);data.index=data.index-1;self.spotlight(data.index);if(data.index<=0){$('.previous',data.container).hide();}
if(!$('.next',data.container).is(':visible')){$('.next',data.container).show();}};this.quit=function(){data.container.hide();data.overlay.hide();data.container.css('top','auto');data.container.css('left','auto');self.fadeAway(data.index);data.index=0;data.options.quit();};if(typeof data!=='undefined'&&data!==null){return this;}
data={};data.container=$(settings.container);if(data.container.length===0){data.container=$('<div id="griffin-tour-container" style="display: none;">'+'    <div class="contents">'+'    </div>'+'    <div class="footer">'+'        <a href="#" class="previous">&lt;&lt; Previous</a>'+'        <a href="#" class="quit">Quit guide</a>'+'        <a href="#" class="next">Next &gt;&gt; </a>'+'    </div>'+'</div>').appendTo('body');}
data.overlay=$(settings.overlay);if(data.overlay.length===0){data.overlay=$('<div id="griffin-tour-overlay" style="display: none;"></div>').appendTo('body');}
data.index=0;data.self=this;data.options=settings;data.items=[];$('div',this).each(function(){data.items.push($(this));$(this).hide();});$(this).data('griffin-tour',data);if(!data.container.data('tour-bound')){data.container.data('tour-bound',true);$('.next',data.container).on('click',function(e){e.preventDefault();self.moveNext();});$('.previous',data.container).on('click',function(e){e.preventDefault();self.movePrev();});$('.quit',data.container).on('click',function(e){e.preventDefault();self.quit();});}
$(window).scroll(function(){if(typeof data.items[data.index].attr('data-for')!=='undefined'||data.container.css('display')==='none'){return;}
var pos=$(window).scrollTop();data.container.position({"my":"center center","at":"center center","of":$(window)});});this.start();return this;});},destroy:function(){return this.each(function(){var $this=$(this),data=$this.data('griffin-tour');$(window).unbind('.elementOverlay');$this.data('griffin-tour',null);$this.removeData('overlay');});},hide:function(){var $this=$(this),data=$this.data('griffin-tour');this.quit();}};$.fn.griffinTour=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1));}else if(typeof method==='object'||!method){return methods.init.apply(this,arguments);}else{$.error('Method '+method+' does not exist on jQuery.griffinTour');}};})(jQuery);$.griffin.ui={dialogs:{},helpers:{}};$.griffin.ui.dialogs.text={ok:'OK',cancel:'Cancel',yes:'Yes',no:'No',notitle:'Untitled'};$.griffin.ui.helpers.fixContent=function(message){var content=message;try{if(message.indexOf('<')===-1&&message.substr(0,1)!=='#'){content=$('<div>'+message+'</div>');}else{content=$(message);}}catch(errMsg){content=$('<div>'+message+'</div>');}
return content;};$.griffin.ui.dialogs.alert=function(options){"use strict";var defaults={closed:function(){},dialogClass:'griffin-dialog griffin-dialog-alert',title:$.griffin.ui.dialogs.text.notitle,modal:true,width:'auto',buttons:[{text:$.griffin.ui.dialogs.text.ok,click:function(){$(this).dialog("close");$dialog.remove();options.closed();}}]};options=$.extend(defaults,options,true);var content=$.griffin.ui.helpers.fixContent(options.message);var $dialog=$(content).appendTo($('body'));$dialog.dialog(options).show();};$.griffin.ui.dialogs.confirm=function(options){"use strict";var defaults={dialogClass:'griffin-dialog griffin-dialog-confirm',title:$.griffin.ui.dialogs.text.notitle,modal:true,width:'auto',buttons:[{text:$.griffin.ui.dialogs.text.yes,click:function(){$(this).dialog("close");$dialog.remove();options.yes();}},{text:$.griffin.ui.dialogs.text.no,click:function(){$(this).dialog("close");$dialog.remove();options.no();}}]};options=$.extend(defaults,options,true);var content=$.griffin.ui.helpers.fixContent(options.message);var $dialog=$(content).appendTo($('body'));$dialog.dialog(options);};